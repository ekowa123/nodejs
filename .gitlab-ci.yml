stages:
  - build
  - deploy

build_app:
  stage: build
  only:
    - master
  tags:
    - dockerbuilder
  script:
    - echo "Build..."
    - if [ ! "$(docker ps -q -f name=ahmad_hello_node)" ]; then 
        echo "Container empty"; 
      else 
        docker rm -f ahmad_hello_node && docker rmi -f registry.carsworld.id/ahmad/hello-node:buildlocal; 
      fi
    - docker build -t registry.carsworld.id/ahmad/hello-node:buildlocal .
    - docker push registry.carsworld.id/ahmad/hello-node:buildlocal

deploy_app:
  stage: deploy
  only:
    - master
  tags:
    - stgasman
  script:
    - if [ "$(docker stack ls | grep ahmad-stack)" ]; then 
        echo "Stack Exists"; 
        docker service update --force --image registry.carsworld.id/ahmad/hello-node:buildlocal ahmad-stack_microservis;
      else
        echo "Stack Not Exists";
        docker stack deploy --with-registry-auth -c docker-compose.yml ahmad-stack;
      fi
    - echo "Done..."
